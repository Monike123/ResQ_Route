# 01 — PDF Report Generation

## Objective
Generate a comprehensive PDF Safety Route Report (SRR) after each journey, containing route details, safety score, map snapshot, SOS events, and integrity hash.

---

## PDF Structure

| Section | Content |
|---------|---------|
| Header | ResQ Route logo, Report ID, date |
| User Info | Name (redacted partially), journey date |
| Map | Static map with route polyline + unsafe zone markers |
| Journey Stats | Distance, duration, safety score, start/end time |
| Safety Breakdown | Component scores chart |
| SOS Events | If any: time, trigger type, location, resolution |
| Unsafe Zones | Zones passed through with severity |
| Integrity | SHA-256 hash + generation timestamp |
| Footer | "Generated by ResQ Route — Tamper-evident document" |

---

## Flutter PDF Generation

```dart
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;

class SRRReportGenerator {
  Future<Uint8List> generateReport({
    required JourneyModel journey,
    required RouteModel route,
    required List<SOSEventModel> sosEvents,
    required Uint8List mapSnapshot,
    required UserProfileModel user,
  }) async {
    final pdf = pw.Document();
    final logo = await rootBundle.load('assets/images/logo.png');

    pdf.addPage(
      pw.MultiPage(
        pageFormat: PdfPageFormat.a4,
        build: (context) => [
          _buildHeader(logo, journey),
          pw.SizedBox(height: 20),
          _buildMapSection(mapSnapshot),
          pw.SizedBox(height: 20),
          _buildJourneyStats(journey, route),
          pw.SizedBox(height: 20),
          _buildSafetyBreakdown(route.safetyBreakdown),
          if (sosEvents.isNotEmpty) ...[
            pw.SizedBox(height: 20),
            _buildSOSSection(sosEvents),
          ],
          pw.SizedBox(height: 20),
          _buildIntegritySection(journey),
        ],
      ),
    );

    return pdf.save();
  }

  pw.Widget _buildHeader(ByteData logo, JourneyModel journey) {
    return pw.Row(
      mainAxisAlignment: pw.MainAxisAlignment.spaceBetween,
      children: [
        pw.Image(pw.MemoryImage(logo.buffer.asUint8List()), width: 60),
        pw.Column(
          crossAxisAlignment: pw.CrossAxisAlignment.end,
          children: [
            pw.Text('SAFETY ROUTE REPORT', style: pw.TextStyle(fontSize: 18, fontWeight: pw.FontWeight.bold)),
            pw.Text('Report ID: SRR-${journey.id.substring(0, 8).toUpperCase()}'),
            pw.Text('Date: ${DateFormat('dd MMM yyyy').format(journey.startedAt)}'),
          ],
        ),
      ],
    );
  }

  pw.Widget _buildJourneyStats(JourneyModel journey, RouteModel route) {
    return pw.Container(
      padding: pw.EdgeInsets.all(16),
      decoration: pw.BoxDecoration(border: pw.Border.all(color: PdfColors.grey400)),
      child: pw.Column(children: [
        _statRow('Distance', '${route.distanceKm.toStringAsFixed(1)} km'),
        _statRow('Duration', '${route.durationMinutes} min'),
        _statRow('Safety Score', '${route.safetyScore?.toStringAsFixed(0)}/100'),
        _statRow('Status', journey.status.toUpperCase()),
        _statRow('Started', DateFormat('HH:mm:ss').format(journey.startedAt)),
        _statRow('Ended', journey.completedAt != null 
            ? DateFormat('HH:mm:ss').format(journey.completedAt!) : 'N/A'),
      ]),
    );
  }

  pw.Widget _buildIntegritySection(JourneyModel journey) {
    final hash = _generateIntegrityHash(journey);
    return pw.Container(
      padding: pw.EdgeInsets.all(12),
      color: PdfColors.grey100,
      child: pw.Column(children: [
        pw.Text('Document Integrity', style: pw.TextStyle(fontWeight: pw.FontWeight.bold)),
        pw.SizedBox(height: 8),
        pw.Text('SHA-256: $hash', style: pw.TextStyle(fontSize: 8, font: pw.Font.courier())),
        pw.Text('Generated: ${DateTime.now().toUtc().toIso8601String()}'),
        pw.SizedBox(height: 4),
        pw.Text('This document is tamper-evident. Any modification will invalidate the hash.',
            style: pw.TextStyle(fontSize: 7, color: PdfColors.grey700)),
      ]),
    );
  }
}
```

---

## Storage & Access

```dart
// Save PDF to Supabase Storage
final pdfBytes = await generator.generateReport(...);
final fileName = 'reports/${journey.id}/srr_report.pdf';

await Supabase.instance.client.storage
    .from('reports')
    .uploadBinary(fileName, pdfBytes, fileOptions: FileOptions(contentType: 'application/pdf'));

// Store reference in database
await Supabase.instance.client.from('reports').insert({
  'journey_id': journey.id,
  'user_id': user.id,
  'pdf_url': fileName,
  'integrity_hash': hash,
});
```

---

## Verification
- [ ] PDF generated with all sections
- [ ] Map snapshot embedded in PDF
- [ ] Safety breakdown table included
- [ ] SOS events section (if any) included
- [ ] Integrity hash printed on document
- [ ] PDF stored in Supabase Storage
- [ ] File reference saved in `reports` table
